<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallerie personnalisé d'épicerie / Personalized Grocery Gallery</title>
    <script src="js/html2canvas.min.js"></script>

    <!-- 1. MODERN TYPOGRAPHY -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        /* 2. REFINED COLOR PALETTE & SOFTER SHADOWS */
        :root {
            --bg-color: #f8f9fa; /* Softer background */
            --text-color: #212529; /* Darker, but not black */
            --card-bg-color: #ffffff; /* Pure white cards stand out nicely */
            --card-shadow: rgba(0, 0, 0, 0.08); /* Softer shadow */
            --selection-color: #007bff; /* Changed the default green to a nice blue */
            --column-count: 1;
        }

        /* 1. MODERN TYPOGRAPHY (Applied) */
        body {
            font-family: 'Lato', sans-serif; /* New body font */
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2 {
            font-family: 'Poppins', sans-serif; /* New heading font */
        }
        
        /* 3. IMPROVED LAYOUT FOR CONTROLS */
        .controls {
            display: grid; /* Use Grid */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive columns */
            gap: 25px; /* Space between grid items */
            margin-bottom: 30px;
            background-color: var(--card-bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--card-shadow);
            border: 1px solid #e9ecef;
        }
        
        .controls h2 {
            grid-column: 1 / -1; /* Make title span all columns */
            margin-top: 0;
            margin-bottom: 0;
        }
        
        .control-group {
            margin-bottom: 0; /* Remove old margin */
            display: flex;
            flex-direction: column; /* Stack labels on top of inputs */
            align-items: flex-start;
            gap: 10px; /* Space between label and input */
        }
        
        .control-group label {
            font-weight: bold;
        }
        
        #storeToggles {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Two columns for stores */
            gap: 10px;
            width: 100%;
        }

        /* 4. INTERACTIVE FEEDBACK & VISUAL POLISH (Buttons) */
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px; /* Rounded corners */
            font-weight: bold;
            font-family: 'Lato', sans-serif;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px); /* Lifts the button slightly */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            filter: brightness(1.1); /* Makes it a bit brighter */
        }

        button:disabled {
            background-color: #ccc;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        /* --- General and Gallery Styles (Updated) --- */
        h1 { text-align: center; font-size: 50px; }
        h1.subtitle { font-size: 20px; margin-top: -30px; }
        
        #capture-area { background-color: var(--bg-color); }
        .gallery { column-count: var(--column-count); column-gap: 15px; }
        
        .column {
            break-inside: avoid;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg-color);
            padding: 15px;
            box-shadow: 0 4px 12px var(--card-shadow);
            border: 1px solid #e9ecef;
            border-radius: 12px;
        }

        .column.hidden { display: none; }
        .column h2 { text-align: center; margin-bottom: 10px; }
        
        img.grocery-item + img.grocery-item { margin-top: 15px; }
        img { width: 100%; height: auto; display: block; border: 9px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; }
        
        img.selected { border-color: var(--selection-color); }
        
        /* 4. INTERACTIVE FEEDBACK & VISUAL POLISH (Images) */
        img.grocery-item:hover {
            transform: scale(1.03); /* Slightly enlarge image on hover */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Add a shadow on hover */
        }

        body.hiding-borders img.selected { border-color: transparent !important; }
        
        .hide-for-export { display: none !important; }
        
        .info-notes { background-color: #e7f5ff; border-left: 4px solid #007bff; padding: 10px 15px; margin-top: 15px; border-radius: 4px; width: 100%; }
        .info-notes ul { padding-left: 20px; margin: 5px 0; }
        .info-notes li { margin-bottom: 5px; }

        /* --- MODIFICATION : STYLE POUR LA NOTE SPÉCIALE --- */
        .store-note {
            font-size: 0.9em;
            font-style: italic;
            text-align: center;
            margin-top: -5px;
            margin-bottom: 10px;
            color: #dc3545; /* Rouge pour attirer l'attention */
        }
        
        @media print { .controls, button { display: none !important; } body { margin: 0; } img:not(.selected) { display: none; } .column { page-break-inside: avoid; } body.hiding-borders img.selected { border-color: transparent !important; } }
    </style>
</head>
<body>

<div class="controls">
    <h2>Panneau de configuration</h2>
    <div class="control-group">
        <label for="bgColor">Couleur de fond:</label>
        <input type="color" id="bgColor" value="#f8f9fa">
        <label for="textColor">Couleur du texte:</label>
        <input type="color" id="textColor" value="#212529">
    </div>
    <div class="control-group">
        <label for="borderColor">Couleur de sélection:</label>
        <input type="color" id="borderColor" value="#007bff">
        <label><input type="checkbox" id="hideBorderCheckbox"> Cacher la bordure</label>
        <label><input type="checkbox" id="showLogosCheckbox" checked> Afficher les logos</label>
    </div>
    <div class="control-group">
        <label for="columnSlider">Nombre de colonnes: <span id="columnCountLabel">1</span></label>
        <input type="range" id="columnSlider" min="1" max="6" value="1" style="width: 100%;">
    </div>
    <div class="control-group">
        <label>Afficher les magasins:</label>
        <div id="storeToggles"></div>
    </div>
     <div class="control-group">
        <button id="savePrefsButton" style="background-color: #28a745;">Sauvegarder les préférences</button>
        <button id="resetPrefsButton" style="background-color: #dc3545;">Réinitialiser</button>
    </div>
    <div class="info-notes" style="grid-column: 1 / -1;">
        <p><strong>Conseils :</strong></p>
        <ul>
            <li>La meilleure qualité sur mobile est obtenue avec 1 ou 2 colonnes.</li>
            <li>Vous pouvez cliquer sur les items que vous ne voulez pas. S'ils n'ont pas la bordure, ils ne seront pas dans l'image exportée.</li>
        </ul>
    </div>
    <div class="control-group" style="grid-column: 1 / -1; flex-direction: row; gap: 15px; align-items: center; justify-content: center;">
        <button id="exportPngButton">Enregistrer en PNG</button>
        <button id="exportJpgButton">Enregistrer en JPG</button>
        <button id="printButton">Imprimer / PDF</button>
    </div>
    <div id="loadingIndicator" style="display: none; font-weight: bold; margin-top: 10px; grid-column: 1 / -1; text-align: center;">Génération de l'image...</div>
</div>
<div id="capture-area">
    <h1>Ma liste d'épicerie personnalisée à partir du 20 novembre</h1>
    <h1 class="subtitle">par /u/eranumerique, https://eranumerique.github.io/</h1>
    <div class="gallery" id="gallery"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // Data and initial constants
    const logoImageFolder = 'images/logo/';
    const weeklyGroceriesFolder = 'images/weekly-groceries/';
    const stores = {'IGA':'iga.png', 'Maxi':'Maxi.png', 'Metro':'metro.png', 'Super C':'superc.png', 'Adonis':'adonis.png', 'Marché Richelieu':'marcherichelieu.png', 'Provigo':'Provigo.png', 'Supermarché PA':'supermarchepa.png'};
    
    // Element references
    const gallery = document.getElementById('gallery');
    const storeTogglesContainer = document.getElementById('storeToggles');
    const root = document.documentElement;
    const columnSlider = document.getElementById('columnSlider');
    const columnCountLabel = document.getElementById('columnCountLabel');
    const bgColorInput = document.getElementById('bgColor');
    const textColorInput = document.getElementById('textColor');
    const borderColorInput = document.getElementById('borderColor');
    const hideBorderCheckbox = document.getElementById('hideBorderCheckbox');
    const showLogosCheckbox = document.getElementById('showLogosCheckbox');

    // === ALL HELPER FUNCTIONS ARE NOW DEFINED HERE, BEFORE THEY ARE USED ===

    function placeImageInColumn(fileName, folderPath) {
        let detectedStore = fileName.toLowerCase().includes('supermarche pa') ? 'Supermarché PA' : Object.keys(stores).find(store => fileName.includes(store));
        if (detectedStore) {
            const targetColumn = document.querySelector(`.column[data-store="${detectedStore}"]`);
            if (targetColumn) {
                const img = document.createElement('img');
                img.src = folderPath + fileName;
                img.alt = fileName;
                img.addEventListener('click', (e) => e.target.classList.toggle('selected'));
                img.classList.add('selected');
                img.classList.add('grocery-item');
                targetColumn.appendChild(img);
            }
        }
    }

    function initialize(weeklyImageFiles) {
        for (const storeName in stores) {
            const column = document.createElement('div'); column.className = 'column'; column.dataset.store = storeName;
            const title = document.createElement('h2'); title.textContent = storeName;
            const logo = document.createElement('img'); logo.src = logoImageFolder + stores[storeName]; logo.alt = `${storeName} Logo`;
            
            column.appendChild(title); 
            
            // --- MODIFICATION : AJOUT DE LA NOTE POUR SUPERMARCHÉ PA ---
            if (storeName === 'Supermarché PA') {
                const note = document.createElement('p');
                note.className = 'store-note'; // Utilise le style CSS ajouté plus haut
                note.textContent = "Se termine dimanche prochain inclusivement.";
                column.appendChild(note); // Ajoute la note sous le titre
            }
            // --- FIN DE LA MODIFICATION ---
            
            column.appendChild(logo); 
            gallery.appendChild(column);

            const toggleLabel = document.createElement('label'); const toggleCheckbox = document.createElement('input');
            toggleCheckbox.type = 'checkbox'; toggleCheckbox.checked = true; toggleCheckbox.dataset.store = storeName;
            toggleCheckbox.addEventListener('change', (e) => { 
                document.querySelector(`.column[data-store="${e.target.dataset.store}"]`).classList.toggle('hidden', !e.target.checked); 
            });
            toggleLabel.appendChild(toggleCheckbox); toggleLabel.append(` ${storeName}`); storeTogglesContainer.appendChild(toggleLabel);
        }
        weeklyImageFiles.forEach(fileName => { placeImageInColumn(fileName, weeklyGroceriesFolder); });
    }
    
    function savePreferences() {
        const preferredStores = Array.from(document.querySelectorAll('#storeToggles input:checked')).map(cb => cb.dataset.store);
        const allPreferences = {
            columns: columnSlider.value,
            bgColor: bgColorInput.value,
            textColor: textColorInput.value,
            borderColor: borderColorInput.value,
            hideBorder: hideBorderCheckbox.checked,
            showLogos: showLogosCheckbox.checked,
            stores: preferredStores
        };
        localStorage.setItem('groceryGallery_allPreferences', JSON.stringify(allPreferences));
        alert('Préférences sauvegardées !');
    }

    function loadPreferences() {
        const savedPrefsJSON = localStorage.getItem('groceryGallery_allPreferences');
        if (!savedPrefsJSON) return;
        try {
            const prefs = JSON.parse(savedPrefsJSON);
            if (prefs.columns) {
                root.style.setProperty('--column-count', prefs.columns);
                columnSlider.value = prefs.columns;
                columnCountLabel.textContent = prefs.columns;
            }
            if (prefs.bgColor) {
                root.style.setProperty('--bg-color', prefs.bgColor);
                bgColorInput.value = prefs.bgColor;
            }
            if (prefs.textColor) {
                root.style.setProperty('--text-color', prefs.textColor);
                textColorInput.value = prefs.textColor;
            }
            if (prefs.borderColor) {
                root.style.setProperty('--selection-color', prefs.borderColor);
                borderColorInput.value = prefs.borderColor;
            }
            if (typeof prefs.hideBorder !== 'undefined') {
                hideBorderCheckbox.checked = prefs.hideBorder;
            }
            if (typeof prefs.showLogos !== 'undefined') {
                showLogosCheckbox.checked = prefs.showLogos;
            }
            if (prefs.stores && Array.isArray(prefs.stores)) {
                document.querySelectorAll('#storeToggles input[type="checkbox"]').forEach(checkbox => {
                    const storeName = checkbox.dataset.store;
                    const shouldBeVisible = prefs.stores.includes(storeName);
                    checkbox.checked = shouldBeVisible;
                    document.querySelector(`.column[data-store="${storeName}"]`).classList.toggle('hidden', !shouldBeVisible);
                });
            }
        } catch (e) {
            console.error("Failed to parse saved preferences:", e);
            localStorage.removeItem('groceryGallery_allPreferences');
        }
    }

    function resetPreferences() {
        localStorage.removeItem('groceryGallery_allPreferences');
        alert('Préférences réinitialisées. La page va se recharger.');
        location.reload();
    }

    async function exportGallery(format) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const exportPngButton = document.getElementById('exportPngButton');
        const exportJpgButton = document.getElementById('exportJpgButton');
        const printButton = document.getElementById('printButton');
        loadingIndicator.style.display = 'block';
        exportPngButton.disabled = true; exportJpgButton.disabled = true; printButton.disabled = true;
        const hiddenElements = [];
        document.querySelectorAll('#gallery img.grocery-item:not(.selected), #gallery .column:not(:has(img.selected.grocery-item))').forEach(el => {
            el.classList.add('hide-for-export');
            hiddenElements.push(el);
        });
        if (!showLogosCheckbox.checked) {
            document.querySelectorAll('.column img:not(.grocery-item)').forEach(logo => {
                logo.classList.add('hide-for-export');
                hiddenElements.push(logo);
            });
        }
        if (hideBorderCheckbox.checked) {
            document.body.classList.add('hiding-borders');
        }
        const captureElement = document.getElementById('capture-area');
        try {
            const canvas = await html2canvas(captureElement, {
                scale: Math.min(window.devicePixelRatio, 2),
                useCORS: true,
                backgroundColor: getComputedStyle(root).getPropertyValue('--bg-color').trim()
            });
            const image = canvas.toDataURL(`image/${format}`, format === 'jpeg' ? 0.9 : 1.0);
            const link = document.createElement('a');
            link.href = image;
            link.download = `ma-liste-epicerie.${format}`;
            link.click();
        } catch (error) {
            console.error("Erreur lors de la génération de l'image:", error);
            const currentColumns = columnSlider.value;
            if (parseInt(currentColumns, 10) === 1) {
                alert("L'exportation a échoué. Cela se produit souvent car l'image est trop haute avec 1 seule colonne. Essayez avec 2 colonnes ou plus, ou désélectionnez quelques items.");
            } else {
                alert("Une erreur est survenue lors de la génération de l'image. Essayez d'augmenter le nombre de colonnes ou de désélectionner certains articles.");
            }
        }
        hiddenElements.forEach(el => el.classList.remove('hide-for-export'));
        document.body.classList.remove('hiding-borders');
        loadingIndicator.style.display = 'none';
        exportPngButton.disabled = false; exportJpgButton.disabled = false; printButton.disabled = false;
    }

    // --- MAIN SCRIPT EXECUTION ---
    try {
        // Step 1: Fetch the grocery list from the JSON file
        const response = await fetch('groceries.json');
        if (!response.ok) {
            throw new Error(`Failed to load groceries.json: ${response.statusText}`);
        }
        const weeklyImageFiles = await response.json();

        // Step 2: Build the page content with the fetched data
        initialize(weeklyImageFiles);
        
        // Step 3: Load any saved user preferences
        loadPreferences();

        // Step 4: Attach all event listeners to the controls
        bgColorInput.addEventListener('input', (e) => root.style.setProperty('--bg-color', e.target.value));
        textColorInput.addEventListener('input', (e) => root.style.setProperty('--text-color', e.target.value));
        borderColorInput.addEventListener('input', (e) => root.style.setProperty('--selection-color', e.target.value));
        columnSlider.addEventListener('input', (e) => {
            const count = e.target.value;
            root.style.setProperty('--column-count', count);
            columnCountLabel.textContent = count;
        });
        document.getElementById('savePrefsButton').addEventListener('click', savePreferences);
        document.getElementById('resetPrefsButton').addEventListener('click', resetPreferences);
        document.getElementById('exportPngButton').addEventListener('click', () => exportGallery('png'));
        document.getElementById('exportJpgButton').addEventListener('click', () => exportGallery('jpeg'));
        document.getElementById('printButton').addEventListener('click', () => {
            const hiddenForPrint = [];
            document.querySelectorAll('.column').forEach(col => {
                if (col.querySelectorAll('img.selected').length === 0) {
                    col.classList.add('hide-for-export');
                    hiddenForPrint.push(col);
                }
            });
            if (hideBorderCheckbox.checked) { document.body.classList.add('hiding-borders'); }
            window.print();
            hiddenForPrint.forEach(el => el.classList.remove('hide-for-export'));
            document.body.classList.remove('hiding-borders');
        });

    } catch (error) {
        console.error("CRITICAL ERROR:", error);
        alert("ERREUR CRITIQUE : Impossible de charger la liste d'épicerie (groceries.json). La page ne peut pas fonctionner. Assurez-vous que le fichier existe et qu'il est accessible.");
    }
});
</script>

<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>